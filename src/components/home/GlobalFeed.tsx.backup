// src/components/home/GlobalFeed.tsx
'use client';

import { useEffect, useState, useCallback } from 'react';
import Link from 'next/link';
import debounce from 'lodash/debounce';

type Prediction = {
  _id: string;
  userName: string;
  ticker: string;
  tickerName: string;
  direction: number;
  ceiling: number;
  floor: number;
  startPrice: number;
  currentPrice: number;
  confidence: number;
  status: string;
  profitRate?: number;
  createdAt: string;
  isLegacy: boolean;
};

type Filters = {
  ticker: string;
  status: 'all' | 'pending' | 'resolved';
  direction: 'all' | 'bull' | 'bear';
  userType: 'all' | 'legacy' | 'new';
  timeRange: 'all' | 'today' | 'week' | 'month';
  sortBy: 'newest' | 'popular' | 'ending-soon';
};

export default function GlobalFeed() {
  const [predictions, setPredictions] = useState<Prediction[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const [showFilters, setShowFilters] = useState(false);
  
  // Filter states
  const [filters, setFilters] = useState<Filters>({
    ticker: '',
    status: 'all',
    direction: 'all',
    userType: 'all',
    timeRange: 'all',
    sortBy: 'newest',
  });

  // Debounced ticker search
  const debouncedSearch = useCallback(
    debounce((searchTerm: string) => {
      setFilters(prev => ({ ...prev, ticker: searchTerm }));
      setPage(1); // Reset to page 1 on search
    }, 300),
    []
  );

  useEffect(() => {
    async function fetchPredictions() {
      try {
        setIsLoading(true);
        
        // Build query string
        const params = new URLSearchParams({
          page: page.toString(),
          limit: '10',
          ...(filters.ticker && { ticker: filters.ticker }),
          ...(filters.status !== 'all' && { status: filters.status }),
          ...(filters.direction !== 'all' && { direction: filters.direction }),
          ...(filters.userType !== 'all' && { userType: filters.userType }),
          ...(filters.timeRange !== 'all' && { timeRange: filters.timeRange }),
          sortBy: filters.sortBy,
        });

        const response = await fetch(`/api/feed/global?${params}`);
        const data = await response.json();
        
        if (data.success) {
          setPredictions(prev => page === 1 ? data.data : [...prev, ...data.data]);
          setHasMore(data.pagination.hasMore);
        }
      } catch (error) {
        console.error('Failed to fetch global feed:', error);
      } finally {
        setIsLoading(false);
      }
    }

    fetchPredictions();
  }, [page, filters]);

  const loadMore = () => {
    setPage(prev => prev + 1);
  };

  const handleFollow = async (predictionId: string) => {
    try {
      // TODO: Implement follow API call
      console.log('Following prediction:', predictionId);
      alert('è¿½è¹¤åŠŸèƒ½é–‹ç™¼ä¸­...');
    } catch (error) {
      console.error('Follow failed:', error);
      alert('è¿½è¹¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  const updateFilter = (key: keyof Filters, value: string) => {
    setFilters(prev => ({ ...prev, [key]: value }));
    setPage(1); // Reset to page 1 when filter changes
  };

  const clearFilters = () => {
    setFilters({
      ticker: '',
      status: 'all',
      direction: 'all',
      userType: 'all',
      timeRange: 'all',
      sortBy: 'newest',
    });
    setPage(1);
  };

  // Check if any filters are active (excluding sortBy for badge/pill display)
  const hasActiveFilters = 
    filters.ticker !== '' ||
    filters.status !== 'all' ||
    filters.direction !== 'all' ||
    filters.userType !== 'all' ||
    filters.timeRange !== 'all';

  if (isLoading && page === 1) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h2 className="text-lg font-semibold text-gray-900 mb-4">
          å…¨çƒå‹•æ…‹
        </h2>
        <div className="space-y-4">
          {[1, 2, 3].map((i) => (
            <div key={i} className="animate-pulse">
              <div className="h-32 bg-gray-200 rounded-lg"></div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg border border-gray-200 p-6">
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-lg font-semibold text-gray-900">
          å…¨çƒå‹•æ…‹
        </h2>
        <button 
          onClick={() => setShowFilters(!showFilters)}
          className="text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1"
        >
          ğŸ” ç¯©é¸
          {hasActiveFilters && (
            <span className="ml-1 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">
              {[
                filters.ticker !== '',
                filters.status !== 'all',
                filters.direction !== 'all',
                filters.userType !== 'all',
                filters.timeRange !== 'all'
              ].filter(Boolean).length}
            </span>
          )}
        </button>
      </div>

      {/* Filter Panel */}
      {showFilters && (
        <div className="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div className="space-y-4">
            {/* Stock Ticker Search */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                è‚¡ç¥¨ä»£è™Ÿ
              </label>
              <input
                type="text"
                placeholder="æœå°‹è‚¡ç¥¨ä»£è™Ÿæˆ–åç¨±..."
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                onChange={(e) => debouncedSearch(e.target.value)}
                defaultValue={filters.ticker}
              />
            </div>

            {/* Status Filter */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ç‹€æ…‹
              </label>
              <div className="flex gap-2">
                {[
                  { value: 'all', label: 'å…¨éƒ¨' },
                  { value: 'pending', label: 'é€²è¡Œä¸­' },
                  { value: 'resolved', label: 'å·²çµæŸ' },
                ].map(option => (
                  <button
                    key={option.value}
                    onClick={() => updateFilter('status', option.value)}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                      filters.status === option.value
                        ? 'bg-blue-600 text-white'
                        : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    {option.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Direction Filter */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                æ–¹å‘
              </label>
              <div className="flex gap-2">
                {[
                  { value: 'all', label: 'å…¨éƒ¨', icon: '' },
                  { value: 'bull', label: 'çœ‹æ¼²', icon: 'ğŸ‚' },
                  { value: 'bear', label: 'çœ‹è·Œ', icon: 'ğŸ»' },
                ].map(option => (
                  <button
                    key={option.value}
                    onClick={() => updateFilter('direction', option.value)}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                      filters.direction === option.value
                        ? 'bg-blue-600 text-white'
                        : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    {option.icon} {option.label}
                  </button>
                ))}
              </div>
            </div>

            {/* User Type Filter */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ç”¨æˆ¶é¡å‹
              </label>
              <div className="flex gap-2">
                {[
                  { value: 'all', label: 'å…¨éƒ¨' },
                  { value: 'new', label: 'æ–°ç”¨æˆ¶' },
                  { value: 'legacy', label: 'Legacy' },
                ].map(option => (
                  <button
                    key={option.value}
                    onClick={() => updateFilter('userType', option.value)}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                      filters.userType === option.value
                        ? 'bg-blue-600 text-white'
                        : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    {option.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Time Range Filter */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                æ™‚é–“ç¯„åœ
              </label>
              <div className="flex gap-2 flex-wrap">
                {[
                  { value: 'all', label: 'å…¨éƒ¨æ™‚é–“' },
                  { value: 'today', label: 'ä»Šå¤©' },
                  { value: 'week', label: 'æœ¬é€±' },
                  { value: 'month', label: 'æœ¬æœˆ' },
                ].map(option => (
                  <button
                    key={option.value}
                    onClick={() => updateFilter('timeRange', option.value)}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                      filters.timeRange === option.value
                        ? 'bg-blue-600 text-white'
                        : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    {option.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Sort By */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                æ’åºæ–¹å¼
              </label>
              <div className="flex gap-2 flex-wrap">
                {[
                  { value: 'newest', label: 'æœ€æ–°' },
                  { value: 'popular', label: 'æœ€å¤šè¿½è¹¤' },
                  { value: 'ending-soon', label: 'å³å°‡çµæŸ' },
                ].map(option => (
                  <button
                    key={option.value}
                    onClick={() => updateFilter('sortBy', option.value)}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                      filters.sortBy === option.value
                        ? 'bg-blue-600 text-white'
                        : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    {option.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Clear Filters */}
            {hasActiveFilters && (
              <button
                onClick={clearFilters}
                className="w-full px-4 py-2 text-sm text-gray-700 hover:text-gray-900 font-medium"
              >
                æ¸…é™¤æ‰€æœ‰ç¯©é¸
              </button>
            )}
          </div>
        </div>
      )}

      {/* Active Filter Pills */}
      {hasActiveFilters && !showFilters && (
        <div className="mb-4 flex flex-wrap gap-2">
          {filters.ticker && (
            <span className="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
              è‚¡ç¥¨: {filters.ticker}
              <button
                onClick={() => updateFilter('ticker', '')}
                className="hover:text-blue-900"
              >
                Ã—
              </button>
            </span>
          )}
          {filters.status !== 'all' && (
            <span className="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
              {filters.status === 'pending' ? 'é€²è¡Œä¸­' : 'å·²çµæŸ'}
              <button
                onClick={() => updateFilter('status', 'all')}
                className="hover:text-blue-900"
              >
                Ã—
              </button>
            </span>
          )}
          {filters.direction !== 'all' && (
            <span className="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
              {filters.direction === 'bull' ? 'ğŸ‚ çœ‹æ¼²' : 'ğŸ» çœ‹è·Œ'}
              <button
                onClick={() => updateFilter('direction', 'all')}
                className="hover:text-blue-900"
              >
                Ã—
              </button>
            </span>
          )}
          {filters.userType !== 'all' && (
            <span className="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
              {filters.userType === 'new' ? 'æ–°ç”¨æˆ¶' : 'Legacy'}
              <button
                onClick={() => updateFilter('userType', 'all')}
                className="hover:text-blue-900"
              >
                Ã—
              </button>
            </span>
          )}
          {filters.timeRange !== 'all' && (
            <span className="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
              {filters.timeRange === 'today' ? 'ä»Šå¤©' : filters.timeRange === 'week' ? 'æœ¬é€±' : 'æœ¬æœˆ'}
              <button
                onClick={() => updateFilter('timeRange', 'all')}
                className="hover:text-blue-900"
              >
                Ã—
              </button>
            </span>
          )}
        </div>
      )}

      {/* Predictions List */}
      <div className="space-y-4">
        {predictions.length === 0 ? (
          <div className="text-center py-12">
            <p className="text-gray-500">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„é æ¸¬</p>
            {hasActiveFilters && (
              <button
                onClick={clearFilters}
                className="mt-4 text-blue-600 hover:text-blue-700 font-medium"
              >
                æ¸…é™¤ç¯©é¸
              </button>
            )}
          </div>
        ) : (
          predictions.map((pred) => (
            <PredictionCard
              key={pred._id}
              prediction={pred}
              onFollow={handleFollow}
            />
          ))
        )}
      </div>

      {/* Load More Button */}
      {hasMore && predictions.length > 0 && (
        <div className="mt-6 text-center">
          <button
            onClick={loadMore}
            disabled={isLoading}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
          >
            {isLoading ? 'è¼‰å…¥ä¸­...' : 'è¼‰å…¥æ›´å¤š'}
          </button>
        </div>
      )}
    </div>
  );
}

// Separate PredictionCard component for better organization
interface PredictionCardProps {
  prediction: Prediction;
  onFollow: (predictionId: string) => void;
}

function PredictionCard({ prediction, onFollow }: PredictionCardProps) {
  // Calculate price position for the visual indicator
  const priceProgress = 
    ((prediction.currentPrice - prediction.floor) / 
     (prediction.ceiling - prediction.floor)) * 100;
  
  // Clamp between 0 and 100
  const clampedProgress = Math.min(Math.max(priceProgress, 0), 100);
  
  // Format date
  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffHours < 1) return 'å‰›å‰›';
    if (diffHours < 24) return `${diffHours} å°æ™‚å‰`;
    if (diffDays < 7) return `${diffDays} å¤©å‰`;
    return date.toLocaleDateString('zh-TW');
  };

  return (
    <Link 
      href={`/prediction/${prediction._id}`}
      className="block border border-gray-200 rounded-lg p-4 hover:border-blue-400 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
    >
      {/* User Header */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
            <span className="text-xs font-semibold text-gray-600">
              {prediction.userName.substring(0, 2).toUpperCase()}
            </span>
          </div>
          <div>
            <p className="text-sm font-medium text-gray-900">
              @{prediction.userName}
            </p>
          </div>
          {prediction.isLegacy && (
            <span className="px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded">
              Legacy
            </span>
          )}
        </div>
        <span className="text-xs text-gray-500">
          {formatDate(prediction.createdAt)}
        </span>
      </div>

      {/* Prediction Content */}
      <div className="mb-4">
        {/* Stock Info */}
        <div className="flex items-center gap-2 mb-3">
          <span className="text-2xl">
            {prediction.direction === 1 ? 'ğŸ‚' : 'ğŸ»'}
          </span>
          <h3 className="text-lg font-bold text-gray-900">
            {prediction.ticker} {prediction.tickerName}
          </h3>
        </div>

        {/* Visual Price Indicator */}
        <div className="mt-3">
          <div className="flex items-center justify-between text-sm text-gray-600 mb-1">
            <span>åœ°æ¿</span>
            <span className="font-medium text-blue-600">â†’ ç›®å‰</span>
            <span>å¤©èŠ±æ¿</span>
          </div>
          
          {/* Progress Bar */}
          <div className="relative h-2 bg-gray-200 rounded-full mb-1">
            <div 
              className="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-blue-600 rounded-full border-2 border-white shadow-md transition-all"
              style={{ left: `${clampedProgress}%` }}
            />
          </div>
          
          <div className="flex items-center justify-between text-sm">
            <span className="text-gray-900">${prediction.floor}</span>
            <span className="font-bold text-blue-600">${prediction.currentPrice}</span>
            <span className="text-gray-900">${prediction.ceiling}</span>
          </div>
          
          <div className="text-xs text-gray-500 mt-1">
            èµ·å§‹: ${prediction.startPrice}
          </div>
        </div>

        {/* Status Badge */}
        <div className="mt-3">
          <span className={`inline-block px-3 py-1 rounded-full text-sm font-medium ${
            prediction.status === 'pending' 
              ? 'bg-orange-100 text-orange-700' 
              : prediction.status.includes('success')
              ? 'bg-green-100 text-green-700'
              : 'bg-red-100 text-red-700'
          }`}>
            {prediction.status === 'pending' ? 'é€²è¡Œä¸­' : 
             prediction.status.includes('success') ? 'æˆåŠŸ' : 'å¤±æ•—'}
          </span>
        </div>
      </div>

      {/* Action Buttons - Prevent link navigation */}
      <div 
        className="flex gap-2"
        onClick={(e) => {
          e.preventDefault();
          e.stopPropagation();
        }}
      >
        <button 
          onClick={(e) => {
            e.preventDefault();
            e.stopPropagation();
            window.location.href = `/prediction/${prediction._id}`;
          }}
          className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-center gap-1"
        >
          ğŸ‘ï¸ æŸ¥çœ‹è©³æƒ…
        </button>
        
        {prediction.status === 'pending' && (
          <button 
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              onFollow(prediction._id);
            }}
            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            è¿½è¹¤
          </button>
        )}
      </div>
    </Link>
  );
}